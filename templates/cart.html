<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Cart</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #f8f9fa;
        color: #333;
        font-size: 16px;
      }

      h2 {
        color: #e44d26;
        border-bottom: 2px solid #d43f1a;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 32px;
      }

      #cart-items-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        transition: box-shadow 0.3s;
      }

      #cart-items-table th,
      #cart-items-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #d6d6d6;
      }

      #cart-items-table th {
        background-color: #e44d26;
        color: #fff;
      }

      .cart-item {
        transition: background-color 0.3s;
      }

      .cart-item:hover {
        background-color: #f9f9f9;
      }

      .product-name {
        font-weight: bold;
        color: #000;
        font-size: 18px;
      }

      .quantity,
      .price,
      .total-price {
        color: #6c757d;
        font-size: 16px;
      }

      .remove-from-cart,
      button,
      #go-back-btn {
        background-color: #d9534f;
        color: #fff;
        border: none;
        padding: 15px 20px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
        font-size: 18px;
        border-radius: 8px;
        width: auto;
        display: inline-block;
        text-align: center;
        margin-top: 20px;
      }

      .remove-from-cart:hover,
      button:hover,
      #go-back-btn:hover {
        background-color: #c9302c;
        transform: scale(1.1);
      }

      #checkout-price {
        color: #e44d26;
        font-weight: bold;
        font-size: 20px;
        margin-top: 20px;
      }

      #empty-cart-message {
        text-align: center;
        font-size: 24px;
        color: #6c757d;
        margin-top: 50px;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      #browse-products-btn {
        background-color: #28a745;
        color: #fff;
        border: none;
        padding: 15px 20px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
        font-size: 18px;
        border-radius: 8px;
        margin-top: 20px;
      }

      #browse-products-btn:hover {
        background-color: #218838;
        transform: scale(1.1);
      }
    </style>
  </head>
  <body>
    <h2>Shopping Cart</h2>
    <button id="go-back-btn" onclick="goBack()">
      Go Back to Customer Home
    </button>

    {% if cart_items_count > 0 %}
    <table id="cart-items-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr
          class="cart-item"
          data-product-name="{{ item.product_name }}"
          data-item-id="{{ item._id }}"
        >
          <td class="product-name">
            {{ item.product_name if 'product_name' in item else 'Product Not
            Found' }}
          </td>
          <td class="price">₹{{ item.price }}</td>
          <td class="quantity">{{ item.quantity }}</td>
          <td class="total-price">₹{{ item.price * item.quantity }}</td>
          <td>
            <button
              class="remove-from-cart"
              onclick="removeFromCart('{{ item._id }}')"
            >
              Remove
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p id="checkout-price">
      Total Checkout Price: ₹<span id="checkout-amount">0.00</span>
    </p>

    <button type="button" onclick="checkout()">Checkout</button>
    {% else %}
    <div id="empty-cart-message">
      <p>Your cart is empty. Start shopping to add items!</p>
      <button id="browse-products-btn" onclick="goToProductList()">
        Browse Products
      </button>
    </div>
    {% endif %}

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
      $(document).ready(function () {
        $(".remove-from-cart").on("click", function () {
          var listItem = $(this).closest("tr");
          var productId = listItem.data("item-id");

          $.ajax({
            type: "POST",
            url: "/remove_from_cart",
            data: { product_id: productId },
            success: function (data) {
              location.reload();
            },
          });
        });

        updateTotalCheckoutPrice();
      });

      function removeFromCart(productId) {
        $.ajax({
          type: "POST",
          url: "/decrement_or_remove_from_cart",
          data: { product_id: productId },
          success: function (data) {
            location.reload();
          },
        });
      }

      function goBack() {
        window.location.href = "/customer_home";
      }

      function goToProductList() {
        window.location.href = "/customer_home";
      }

      function updateTotalCheckoutPrice() {
        var cartItems = [];
        $("#cart-items-table tbody .cart-item").each(function () {
          var productName = $(this).data("product-name");
          var quantity = parseInt($(this).find(".quantity").text());
          var price = parseFloat(
            $(this).find(".price").text().replace("₹", "")
          );
          cartItems.push({
            product_name: productName,
            quantity: quantity,
            price: price,
          });
        });

        var totalCheckoutPrice = cartItems.reduce(function (total, item) {
          return total + item.quantity * item.price;
        }, 0);

        $("#checkout-amount").text(totalCheckoutPrice.toFixed(2));
      }

      function checkout() {
        var cartItems = [];
        $("#cart-items-table tbody .cart-item").each(function () {
          var productName = $(this).data("product-name");
          var quantity = parseInt($(this).find(".quantity").text());
          var price = parseFloat(
            $(this).find(".price").text().replace("₹", "")
          );
          cartItems.push({
            product_name: productName,
            quantity: quantity,
            price: price,
          });
        });

        var totalCheckoutPrice = cartItems.reduce(function (total, item) {
          return total + item.quantity * item.price;
        }, 0);

        $("#checkout-amount").text(totalCheckoutPrice.toFixed(2));

        $.ajax({
          type: "POST",
          url: "/checkout",
          contentType: "application/json",
          data: JSON.stringify({ order_details: cartItems }),
          success: function (data) {
            alert(data.message);
            window.location.href = "/customer_home";
          },
          error: function (error) {
            alert("Error during checkout. Please try again.");
          },
        });
      }
    </script>
  </body>
</html>
